# Groups åŠŸèƒ½è®¾ç½®è¯¦ç»†æ­¥éª¤æŒ‡å—

## ğŸ“‹ å‡†å¤‡å·¥ä½œ

ç¡®ä¿ä½ å·²ç»ï¼š
- âœ… æœ‰ Supabase è´¦æˆ·
- âœ… åˆ›å»ºäº† Supabase é¡¹ç›®
- âœ… åœ¨é¡¹ç›®ä¸­é…ç½®äº†ç¯å¢ƒå˜é‡ï¼ˆEXPO_PUBLIC_SUPABASE_URL å’Œ EXPO_PUBLIC_SUPABASE_ANON_KEYï¼‰

---

## æ­¥éª¤ 1: åœ¨ Supabase Dashboard ä¸­æ‰§è¡Œ groups-setup.sql

### 1.1 æ‰“å¼€ Supabase Dashboard

1. è®¿é—® [https://app.supabase.com](https://app.supabase.com)
2. ç™»å½•ä½ çš„è´¦æˆ·
3. é€‰æ‹©ä½ çš„é¡¹ç›®

### 1.2 æ‰“å¼€ SQL Editor

1. åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œç‚¹å‡» **SQL Editor**ï¼ˆSQL ç¼–è¾‘å™¨ï¼‰
2. ç‚¹å‡» **New query**ï¼ˆæ–°å»ºæŸ¥è¯¢ï¼‰æŒ‰é’®

### 1.3 å¤åˆ¶ SQL è„šæœ¬

1. åœ¨ä½ çš„é¡¹ç›®ä¸­æ‰“å¼€ `groups-setup.sql` æ–‡ä»¶
2. å…¨é€‰å¹¶å¤åˆ¶æ‰€æœ‰å†…å®¹ï¼ˆCtrl+A / Cmd+Aï¼Œç„¶å Ctrl+C / Cmd+Cï¼‰

### 1.4 ç²˜è´´å¹¶æ‰§è¡Œ

1. åœ¨ Supabase SQL Editor ä¸­ï¼Œç²˜è´´å¤åˆ¶çš„ SQL ä»£ç 
2. ç‚¹å‡»å³ä¸Šè§’çš„ **Run**ï¼ˆè¿è¡Œï¼‰æŒ‰é’®ï¼Œæˆ–æŒ‰ `Ctrl+Enter` / `Cmd+Enter`

### 1.5 å¤„ç†è­¦å‘Šï¼ˆå¦‚æœæœ‰ï¼‰

- å¦‚æœçœ‹åˆ° "destructive operations" è­¦å‘Šï¼Œè¿™æ˜¯æ­£å¸¸çš„
- SQL è„šæœ¬ä½¿ç”¨äº† `IF EXISTS`ï¼Œæ‰€ä»¥æ˜¯å®‰å…¨çš„
- ç‚¹å‡» **Run this query** ç»§ç»­æ‰§è¡Œ

### 1.6 éªŒè¯æ‰§è¡Œç»“æœ

æ‰§è¡ŒæˆåŠŸåï¼Œä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„æ¶ˆæ¯ï¼š
```
Success. No rows returned
```

### 1.7 éªŒè¯è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ

åœ¨ SQL Editor ä¸­è¿è¡Œä»¥ä¸‹æŸ¥è¯¢æ¥éªŒè¯ï¼š

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('friends', 'groups', 'group_members');
```

åº”è¯¥è¿”å› 3 è¡Œï¼š
- friends
- groups
- group_members

---

## æ­¥éª¤ 2: åˆ›å»º group-images Storage Bucket

### 2.1 æ‰“å¼€ Storage

1. åœ¨ Supabase Dashboard å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œç‚¹å‡» **Storage**ï¼ˆå­˜å‚¨ï¼‰
2. ç‚¹å‡» **New bucket**ï¼ˆæ–°å»ºå­˜å‚¨æ¡¶ï¼‰æŒ‰é’®

### 2.2 é…ç½® Bucket

åœ¨åˆ›å»º bucket çš„å¯¹è¯æ¡†ä¸­ï¼š

1. **Nameï¼ˆåç§°ï¼‰**: è¾“å…¥ `group-images`
   - âš ï¸ å¿…é¡»å®Œå…¨åŒ¹é…ï¼ŒåŒºåˆ†å¤§å°å†™

2. **Public bucketï¼ˆå…¬å…±å­˜å‚¨æ¡¶ï¼‰**: âœ… **å‹¾é€‰**
   - è¿™å…è®¸æ‰€æœ‰äººæŸ¥çœ‹ç¾¤ç»„å›¾ç‰‡

3. **File size limitï¼ˆæ–‡ä»¶å¤§å°é™åˆ¶ï¼‰**: å¯ä»¥è®¾ç½®ä¸º 5MB æˆ– 10MBï¼ˆå¯é€‰ï¼‰

4. **Allowed MIME typesï¼ˆå…è®¸çš„ MIME ç±»å‹ï¼‰**: å¯ä»¥ç•™ç©ºï¼Œæˆ–è¾“å…¥ `image/*`ï¼ˆå¯é€‰ï¼‰

5. ç‚¹å‡» **Create bucket**ï¼ˆåˆ›å»ºå­˜å‚¨æ¡¶ï¼‰

### 2.3 éªŒè¯ Bucket åˆ›å»º

ä½ åº”è¯¥åœ¨ Storage åˆ—è¡¨ä¸­çœ‹åˆ° `group-images` bucket

---

## æ­¥éª¤ 3: é…ç½® Storage Policiesï¼ˆå­˜å‚¨ç­–ç•¥ï¼‰

### 3.1 æ‰“å¼€ Policies æ ‡ç­¾

1. åœ¨ Storage é¡µé¢ï¼Œç‚¹å‡» `group-images` bucket
2. ç‚¹å‡»é¡¶éƒ¨çš„ **Policies**ï¼ˆç­–ç•¥ï¼‰æ ‡ç­¾

### 3.2 åˆ›å»º Policy 1: å…è®¸ä¸Šä¼ å›¾ç‰‡

1. ç‚¹å‡» **New Policy**ï¼ˆæ–°å»ºç­–ç•¥ï¼‰
2. é€‰æ‹© **For full customization**ï¼ˆå®Œå…¨è‡ªå®šä¹‰ï¼‰
3. åœ¨ç­–ç•¥ç¼–è¾‘å™¨ä¸­ï¼Œç²˜è´´ä»¥ä¸‹ SQLï¼š

```sql
CREATE POLICY "Users can upload group images"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'group-images' AND
  auth.uid()::text = (storage.foldername(name))[1]
);
```

4. ç‚¹å‡» **Review**ï¼ˆå®¡æŸ¥ï¼‰
5. ç‚¹å‡» **Save policy**ï¼ˆä¿å­˜ç­–ç•¥ï¼‰

### 3.3 åˆ›å»º Policy 2: å…è®¸æ›´æ–°å›¾ç‰‡

1. å†æ¬¡ç‚¹å‡» **New Policy**
2. é€‰æ‹© **For full customization**
3. ç²˜è´´ä»¥ä¸‹ SQLï¼š

```sql
CREATE POLICY "Users can update group images"
ON storage.objects FOR UPDATE
USING (
  bucket_id = 'group-images' AND
  auth.uid()::text = (storage.foldername(name))[1]
);
```

4. ç‚¹å‡» **Review**ï¼Œç„¶å **Save policy**

### 3.4 åˆ›å»º Policy 3: å…è®¸åˆ é™¤å›¾ç‰‡

1. ç‚¹å‡» **New Policy**
2. é€‰æ‹© **For full customization**
3. ç²˜è´´ä»¥ä¸‹ SQLï¼š

```sql
CREATE POLICY "Users can delete group images"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'group-images' AND
  auth.uid()::text = (storage.foldername(name))[1]
);
```

4. ç‚¹å‡» **Review**ï¼Œç„¶å **Save policy**

### 3.5 åˆ›å»º Policy 4: å…è®¸æŸ¥çœ‹å›¾ç‰‡

1. ç‚¹å‡» **New Policy**
2. é€‰æ‹© **For full customization**
3. ç²˜è´´ä»¥ä¸‹ SQLï¼š

```sql
CREATE POLICY "Anyone can view group images"
ON storage.objects FOR SELECT
USING (bucket_id = 'group-images');
```

4. ç‚¹å‡» **Review**ï¼Œç„¶å **Save policy**

### 3.6 éªŒè¯ Policies

ä½ åº”è¯¥åœ¨ Policies åˆ—è¡¨ä¸­çœ‹åˆ° 4 ä¸ªç­–ç•¥ï¼š
- Users can upload group images
- Users can update group images
- Users can delete group images
- Anyone can view group images

---

## æ­¥éª¤ 4: æµ‹è¯•åˆ›å»ºç¾¤ç»„åŠŸèƒ½

### 4.1 å¯åŠ¨åº”ç”¨

1. åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š
   ```bash
   npm start
   ```
   æˆ–
   ```bash
   expo start
   ```

2. åœ¨æ¨¡æ‹Ÿå™¨æˆ–çœŸæœºä¸Šæ‰“å¼€åº”ç”¨

### 4.2 ç™»å½•è´¦æˆ·

1. ç¡®ä¿ä½ å·²ç»ç™»å½•ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œå…ˆç™»å½•æˆ–æ³¨å†Œï¼‰

### 4.3 å¯¼èˆªåˆ°åˆ›å»ºç¾¤ç»„é¡µé¢

æ ¹æ®ä½ çš„å¯¼èˆªç»“æ„ï¼Œæ‰¾åˆ°è¿›å…¥ "Create Group" æˆ– "Add New Group" é¡µé¢çš„æ–¹å¼

### 4.4 æµ‹è¯•åŸºæœ¬åŠŸèƒ½

#### æµ‹è¯• 1: è¾“å…¥ç¾¤ç»„åç§°
1. åœ¨ "Enter Group Name..." è¾“å…¥æ¡†ä¸­è¾“å…¥åç§°
2. âœ… éªŒè¯ï¼šå³ä¾§æ˜¾ç¤ºå­—ç¬¦è®¡æ•°ï¼ˆä¾‹å¦‚ï¼š5/50ï¼‰
3. âœ… éªŒè¯ï¼šè¾“å…¥è¶…è¿‡ 50 ä¸ªå­—ç¬¦æ—¶æ— æ³•ç»§ç»­è¾“å…¥

#### æµ‹è¯• 2: è¾“å…¥ç¾¤ç»„æè¿°
1. åœ¨ "Enter Group Description..." è¾“å…¥æ¡†ä¸­è¾“å…¥æè¿°
2. âœ… éªŒè¯ï¼šå³ä¸‹è§’æ˜¾ç¤ºå­—ç¬¦è®¡æ•°ï¼ˆä¾‹å¦‚ï¼š20/450ï¼‰
3. âœ… éªŒè¯ï¼šå¯ä»¥å¤šè¡Œè¾“å…¥

#### æµ‹è¯• 3: ä¸Šä¼ ç¾¤ç»„å›¾ç‰‡
1. ç‚¹å‡»å³ä¾§çš„å›¾ç‰‡å ä½ç¬¦
2. âœ… éªŒè¯ï¼šå¼¹å‡ºå›¾ç‰‡é€‰æ‹©å™¨
3. é€‰æ‹©ä¸€å¼ å›¾ç‰‡
4. âœ… éªŒè¯ï¼šå›¾ç‰‡æ˜¾ç¤ºåœ¨å ä½ç¬¦ä¸­

#### æµ‹è¯• 4: æœç´¢å¥½å‹
1. åœ¨ "Search Friends" è¾“å…¥æ¡†ä¸­è¾“å…¥å¥½å‹åç§°
2. âœ… éªŒè¯ï¼šå¥½å‹åˆ—è¡¨å®æ—¶è¿‡æ»¤
3. âœ… éªŒè¯ï¼šæ¸…ç©ºæœç´¢åæ˜¾ç¤ºæ‰€æœ‰å¥½å‹

#### æµ‹è¯• 5: é€‰æ‹©å¥½å‹
1. ç‚¹å‡»å¥½å‹åˆ—è¡¨ä¸­çš„æŸä¸ªå¥½å‹
2. âœ… éªŒè¯ï¼šå¤é€‰æ¡†è¢«é€‰ä¸­ï¼ˆæ˜¾ç¤ºçº¢è‰²å¯¹å‹¾ï¼‰
3. å†æ¬¡ç‚¹å‡»
4. âœ… éªŒè¯ï¼šå¤é€‰æ¡†å–æ¶ˆé€‰ä¸­

#### æµ‹è¯• 6: åˆ›å»ºç¾¤ç»„
1. å¡«å†™ç¾¤ç»„åç§°ï¼ˆå¿…å¡«ï¼‰
2. ï¼ˆå¯é€‰ï¼‰å¡«å†™æè¿°
3. ï¼ˆå¯é€‰ï¼‰ä¸Šä¼ å›¾ç‰‡
4. ï¼ˆå¯é€‰ï¼‰é€‰æ‹©å¥½å‹
5. ç‚¹å‡» "Create New Group" æŒ‰é’®
6. âœ… éªŒè¯ï¼šæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼ˆæŒ‰é’®æ–‡å­—å˜ä¸º "Creating..."ï¼‰
7. âœ… éªŒè¯ï¼šæ˜¾ç¤ºæˆåŠŸæç¤º "Group 'xxx' created successfully!"
8. âœ… éªŒè¯ï¼šç‚¹å‡» OK åè¿”å›ä¸Šä¸€é¡µ

### 4.5 éªŒè¯æ•°æ®åº“ä¸­çš„æ•°æ®

åœ¨ Supabase Dashboard ä¸­éªŒè¯ï¼š

#### æ£€æŸ¥ groups è¡¨
1. åœ¨å·¦ä¾§å¯¼èˆªæ ï¼Œç‚¹å‡» **Table Editor**ï¼ˆè¡¨ç¼–è¾‘å™¨ï¼‰
2. é€‰æ‹© `groups` è¡¨
3. âœ… éªŒè¯ï¼šåº”è¯¥çœ‹åˆ°ä½ åˆšåˆ›å»ºçš„ç¾¤ç»„
4. âœ… éªŒè¯ï¼š`name`ã€`description`ã€`image_url`ã€`created_by` å­—æ®µéƒ½æœ‰å€¼

#### æ£€æŸ¥ group_members è¡¨
1. åœ¨ Table Editor ä¸­é€‰æ‹© `group_members` è¡¨
2. âœ… éªŒè¯ï¼šåº”è¯¥çœ‹åˆ°è‡³å°‘ä¸€æ¡è®°å½•ï¼ˆåˆ›å»ºè€…ä½œä¸º adminï¼‰
3. âœ… éªŒè¯ï¼šå¦‚æœé€‰æ‹©äº†å¥½å‹ï¼Œåº”è¯¥çœ‹åˆ°å¯¹åº”çš„ member è®°å½•

#### æ£€æŸ¥ Storage
1. åœ¨ Storage ä¸­ï¼Œç‚¹å‡» `group-images` bucket
2. âœ… éªŒè¯ï¼šå¦‚æœä¸Šä¼ äº†å›¾ç‰‡ï¼Œåº”è¯¥çœ‹åˆ°å›¾ç‰‡æ–‡ä»¶

---

## æ­¥éª¤ 5: æµ‹è¯•å¥½å‹åˆ—è¡¨åŠ è½½

### 5.1 å‡†å¤‡æµ‹è¯•æ•°æ®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰å¥½å‹ï¼‰

å¦‚æœ `friends` è¡¨æ˜¯ç©ºçš„ï¼Œä½ éœ€è¦å…ˆæ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®ï¼š

#### æ–¹æ³• 1: é€šè¿‡åº”ç”¨æ·»åŠ å¥½å‹
1. ä½¿ç”¨ Add New Friend åŠŸèƒ½æ·»åŠ å¥½å‹
2. ç¡®ä¿å¥½å‹å…³ç³»çŠ¶æ€ä¸º 'accepted'

#### æ–¹æ³• 2: ç›´æ¥åœ¨æ•°æ®åº“ä¸­æ’å…¥æµ‹è¯•æ•°æ®

åœ¨ SQL Editor ä¸­è¿è¡Œï¼ˆæ›¿æ¢ `YOUR_USER_ID` å’Œ `FRIEND_USER_ID`ï¼‰ï¼š

```sql
-- é¦–å…ˆè·å–ä½ çš„ç”¨æˆ· ID
SELECT id, email FROM auth.users;

-- ç„¶åæ’å…¥å¥½å‹å…³ç³»ï¼ˆæ›¿æ¢å®é™…çš„ç”¨æˆ· IDï¼‰
INSERT INTO public.friends (user_id, friend_id, status)
VALUES 
  ('YOUR_USER_ID', 'FRIEND_USER_ID', 'accepted');
```

### 5.2 æµ‹è¯•å¥½å‹åˆ—è¡¨

1. æ‰“å¼€ Create Group é¡µé¢
2. âœ… éªŒè¯ï¼šå¥½å‹åˆ—è¡¨æ˜¾ç¤ºå·²æ¥å—çš„å¥½å‹
3. âœ… éªŒè¯ï¼šæ¯ä¸ªå¥½å‹æ˜¾ç¤ºå¤´åƒå’Œåç§°
4. âœ… éªŒè¯ï¼šå¯ä»¥æœç´¢å’Œé€‰æ‹©å¥½å‹

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜ 1: SQL æ‰§è¡Œå¤±è´¥

**é”™è¯¯**: "relation already exists"
- **è§£å†³**: è¿™æ˜¯æ­£å¸¸çš„ï¼Œè¯´æ˜è¡¨å·²ç»å­˜åœ¨ã€‚å¯ä»¥ç»§ç»­ä¸‹ä¸€æ­¥ã€‚

**é”™è¯¯**: "permission denied"
- **è§£å†³**: ç¡®ä¿ä½ ä½¿ç”¨çš„æ˜¯é¡¹ç›®æ‰€æœ‰è€…è´¦æˆ·ï¼Œæˆ–è€…æœ‰ç®¡ç†å‘˜æƒé™ã€‚

### é—®é¢˜ 2: Bucket åˆ›å»ºå¤±è´¥

**é”™è¯¯**: "bucket already exists"
- **è§£å†³**: è¯´æ˜ bucket å·²ç»å­˜åœ¨ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

**é”™è¯¯**: "invalid bucket name"
- **è§£å†³**: ç¡®ä¿åç§°æ˜¯ `group-images`ï¼ˆå°å†™ï¼Œç”¨è¿å­—ç¬¦ï¼‰ã€‚

### é—®é¢˜ 3: å›¾ç‰‡ä¸Šä¼ å¤±è´¥

**é”™è¯¯**: "new row violates row-level security policy"
- **è§£å†³**: æ£€æŸ¥ Storage Policies æ˜¯å¦æ­£ç¡®åˆ›å»ºï¼Œç‰¹åˆ«æ˜¯ Policy 1ã€‚

**é”™è¯¯**: "bucket not found"
- **è§£å†³**: ç¡®ä¿ bucket åç§°æ˜¯ `group-images`ï¼Œå¹¶ä¸”å·²ç»åˆ›å»ºã€‚

### é—®é¢˜ 4: å¥½å‹åˆ—è¡¨ä¸ºç©º

**å¯èƒ½åŸå› **:
- `friends` è¡¨æ˜¯ç©ºçš„
- å¥½å‹å…³ç³»çŠ¶æ€ä¸æ˜¯ 'accepted'
- RLS ç­–ç•¥é˜»æ­¢äº†è¯»å–

**è§£å†³**:
1. æ£€æŸ¥ `friends` è¡¨ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼š
   ```sql
   SELECT * FROM public.friends;
   ```
2. ç¡®ä¿çŠ¶æ€æ˜¯ 'accepted'
3. åº”ç”¨ä¼šä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºåå¤‡æ–¹æ¡ˆ

### é—®é¢˜ 5: åˆ›å»ºç¾¤ç»„å¤±è´¥

**é”™è¯¯**: "relation 'groups' does not exist"
- **è§£å†³**: ç¡®ä¿å·²ç»æ‰§è¡Œäº† `groups-setup.sql`

**é”™è¯¯**: "new row violates row-level security policy"
- **è§£å†³**: æ£€æŸ¥ `groups` è¡¨çš„ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆæ‰€æœ‰æ­¥éª¤åï¼Œæ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

- [ ] `friends` è¡¨å·²åˆ›å»º
- [ ] `groups` è¡¨å·²åˆ›å»º
- [ ] `group_members` è¡¨å·²åˆ›å»º
- [ ] `group-images` bucket å·²åˆ›å»ºä¸”ä¸ºå…¬å…±
- [ ] 4 ä¸ª Storage Policies å·²åˆ›å»º
- [ ] å¯ä»¥è¾“å…¥ç¾¤ç»„åç§°å¹¶çœ‹åˆ°å­—ç¬¦è®¡æ•°
- [ ] å¯ä»¥è¾“å…¥æè¿°å¹¶çœ‹åˆ°å­—ç¬¦è®¡æ•°
- [ ] å¯ä»¥é€‰æ‹©å’Œä¸Šä¼ å›¾ç‰‡
- [ ] å¯ä»¥æœç´¢å¥½å‹
- [ ] å¯ä»¥é€‰æ‹©å¥½å‹ï¼ˆå¤é€‰æ¡†å·¥ä½œï¼‰
- [ ] å¯ä»¥æˆåŠŸåˆ›å»ºç¾¤ç»„
- [ ] ç¾¤ç»„æ•°æ®å‡ºç°åœ¨ `groups` è¡¨ä¸­
- [ ] æˆå‘˜æ•°æ®å‡ºç°åœ¨ `group_members` è¡¨ä¸­
- [ ] å›¾ç‰‡å‡ºç°åœ¨ Storage ä¸­

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥ Supabase Dashboard ä¸­çš„é”™è¯¯æ—¥å¿—
2. æŸ¥çœ‹åº”ç”¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯
3. éªŒè¯æ‰€æœ‰ SQL è„šæœ¬æ˜¯å¦æˆåŠŸæ‰§è¡Œ
4. ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®

